"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _cucumber = require("cucumber");

var _CucumberEventListener = require("./CucumberEventListener");

var _utils = require("./utils");

var path = _interopRequireWildcard(require("path"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class CucumberReporter {
  constructor(eventBroadcaster, options, cid, specs, reporter) {
    _defineProperty(this, "gherkinDocEvents", []);

    this.capabilities = options.capabilities;
    this.tagsInTitle = options.tagsInTitle || false;
    this.options = options;
    this.cid = cid;
    this.specs = specs;
    this.reporter = reporter;
    this.failedCount = 0;
    new _CucumberEventListener.CucumberEventListener(eventBroadcaster).on('before-feature', this.handleBeforeFeature.bind(this)).on('before-scenario', this.handleBeforeScenario.bind(this)).on('before-step', this.handleBeforeStep.bind(this)).on('after-step', this.handleAfterStep.bind(this)).on('after-scenario', this.handleAfterScenario.bind(this)).on('after-feature', this.handleAfterFeature.bind(this));
  }

  handleBeforeFeature(uri, feature) {
    this.featureStart = new Date();
    this.emit('suite:start', {
      uid: this.getUniqueIdentifier(feature),
      title: this.getTitle(feature),
      type: 'suite',
      file: uri,
      tags: feature.tags,
      description: feature.description,
      keyword: feature.keyword
    });
  }

  handleBeforeScenario(uri, feature, scenario) {
    this.scenarioStart = new Date();
    this.testStart = new Date();
    this.emit('suite:start', {
      uid: this.getUniqueIdentifier(scenario),
      title: this.getTitle(scenario),
      parent: this.getUniqueIdentifier(feature),
      type: 'suite',
      file: uri,
      tags: scenario.tags
    });
  }

  handleBeforeStep(uri, feature, scenario, step, sourceLocation) {
    this.testStart = new Date();
    this.emit('test:start', {
      uid: this.getUniqueIdentifier(step),
      title: step.text,
      type: 'test',
      file: uri,
      parent: this.getUniqueIdentifier(scenario, sourceLocation),
      duration: new Date() - this.testStart,
      tags: scenario.tags,
      featureName: feature.name,
      scenarioName: scenario.name,
      argument: (0, _utils.createStepArgument)(step)
    });
  }

  handleAfterStep(uri, feature, scenario, step, result, sourceLocation) {
    let e = 'undefined';

    switch (result.status) {
      case _cucumber.Status.FAILED:
      case _cucumber.Status.UNDEFINED:
        e = 'fail';
        break;

      case _cucumber.Status.PASSED:
        e = 'pass';
        break;

      case _cucumber.Status.PENDING:
      case _cucumber.Status.SKIPPED:
      case _cucumber.Status.AMBIGUOUS:
        e = 'pending';
    }

    let error = {};
    let stepTitle = step.text || step.keyword || 'Undefined Step';
    /**
     * if step name is undefined we are dealing with a hook
     * don't report hooks if no error happened
     */

    if (!step.text && result.status !== _cucumber.Status.FAILED) {
      return;
    }

    if (result.status === _cucumber.Status.UNDEFINED) {
      if (this.options.ignoreUndefinedDefinitions) {
        /**
         * mark test as pending
         */
        e = 'pending';
        stepTitle += ' (undefined step)';
      } else {
        /**
         * mark test as failed
         */
        this.failedCount++;
        error = {
          message: `Step "${stepTitle}" is not defined. You can ignore this error by setting
                              cucumberOpts.ignoreUndefinedDefinitions as true.`,
          stack: `${step.uri}:${step.line}`
        };
      }
    } else if (result.status === _cucumber.Status.FAILED) {
      /**
       * cucumber failure exception can't get send to parent process
       * for some reasons
       */
      let err = result.exception;

      if (err instanceof Error) {
        error = {
          message: err.message,
          stack: err.stack
        };
      } else {
        error = {
          message: err
        };
      }

      this.failedCount++;
    } else if (result.status === _cucumber.Status.AMBIGUOUS && this.options.failAmbiguousDefinitions) {
      e = 'fail';
      this.failedCount++;
      error = {
        message: result.exception
      };
    }

    const payload = {
      uid: this.getUniqueIdentifier(step),
      title: stepTitle.trim(),
      type: 'test',
      file: uri,
      parent: this.getUniqueIdentifier(scenario, sourceLocation),
      error: error,
      duration: new Date() - this.testStart,
      tags: scenario.tags,
      keyword: step.keyword,
      argument: (0, _utils.createStepArgument)(step)
    };
    this.emit('test:' + e, payload);
  }

  handleAfterScenario(uri, feature, scenario, sourceLocation) {
    this.emit('suite:end', {
      uid: this.getUniqueIdentifier(scenario, sourceLocation),
      title: this.getTitle(scenario),
      parent: this.getUniqueIdentifier(feature),
      type: 'suite',
      file: uri,
      duration: new Date() - this.scenarioStart,
      tags: scenario.tags
    });
  }

  handleAfterFeature(uri, feature) {
    this.emit('suite:end', {
      uid: this.getUniqueIdentifier(feature),
      title: this.getTitle(feature),
      type: 'suite',
      file: uri,
      duration: new Date() - this.featureStart,
      tags: feature.tags
    });
  }

  emit(event, payload) {
    let message = this.formatMessage({
      type: event,
      payload
    });
    message.cid = this.cid;
    message.specs = this.specs;
    message.uid = payload.uid;
    this.reporter.emit(message.type, message);
  }

  getTitle(featureOrScenario) {
    const name = featureOrScenario.name;
    const tags = featureOrScenario.tags;
    if (!this.tagsInTitle || !tags.length) return name;
    return `${tags.map(tag => tag.name).join(', ')}: ${name}`;
  }

  getUriOf(type) {
    if (!type || !type.uri) {
      return;
    }

    return type.uri.replace(process.cwd(), '');
  }

  getUniqueIdentifier(target, sourceLocation) {
    let name;
    let line;

    if (target.type === 'Hook') {
      name = path.basename(target.location.uri);
      line = target.location.line;
    } else if (target.type === 'ScenarioOutline') {
      name = target.name || target.text;
      line = sourceLocation.line;
      target.examples[0].tableHeader.cells.forEach((header, idx) => {
        if (name.indexOf('<' + header.value + '>') > -1) {
          target.examples[0].tableBody.forEach(tableEntry => {
            if (tableEntry.location.line === sourceLocation.line) {
              name = name.replace('<' + header.value + '>', tableEntry.cells[idx].value);
            }
          });
        }
      });
    } else {
      name = target.name || target.text;
      const location = target.location || target.locations[0];
      line = location && location.line || '';
    }

    return name + line;
  }

  formatMessage(params) {
    let message = {
      type: params.type
    };

    if (params.payload && params.payload.error) {
      message.error = params.payload.error;
      /**
       * hook failures are emitted as "test:fail"
       */

      if (params.payload.title && params.payload.title.match(/^"(before|after)( all)*" hook/g)) {
        message.type = 'hook:end';
      }
    }

    if (params.payload) {
      message.title = params.payload.title;
      message.parent = params.payload.parent ? params.payload.parent.title : null;
      message.fullTitle = params.payload.fullTitle ? params.payload.fullTitle() : message.parent + ' ' + message.title;
      message.pending = params.payload.pending || false;
      message.file = params.payload.file;
      message.duration = params.payload.duration;
      /**
       * Add the current test title to the payload for cases where it helps to
       * identify the test, e.g. when running inside a beforeEach hook
       */

      if (params.payload.ctx && params.payload.ctx.currentTest) {
        message.currentTest = params.payload.ctx.currentTest.title;
      }

      if (params.type.match(/Test/)) {
        message.passed = params.payload.state === 'passed';
      }

      if (params.payload.context) {
        message.context = params.payload.context;
      }
    }

    return message;
  }

}

var _default = CucumberReporter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRlci5qcyJdLCJuYW1lcyI6WyJDdWN1bWJlclJlcG9ydGVyIiwiY29uc3RydWN0b3IiLCJldmVudEJyb2FkY2FzdGVyIiwib3B0aW9ucyIsImNpZCIsInNwZWNzIiwicmVwb3J0ZXIiLCJjYXBhYmlsaXRpZXMiLCJ0YWdzSW5UaXRsZSIsImZhaWxlZENvdW50IiwiQ3VjdW1iZXJFdmVudExpc3RlbmVyIiwib24iLCJoYW5kbGVCZWZvcmVGZWF0dXJlIiwiYmluZCIsImhhbmRsZUJlZm9yZVNjZW5hcmlvIiwiaGFuZGxlQmVmb3JlU3RlcCIsImhhbmRsZUFmdGVyU3RlcCIsImhhbmRsZUFmdGVyU2NlbmFyaW8iLCJoYW5kbGVBZnRlckZlYXR1cmUiLCJ1cmkiLCJmZWF0dXJlIiwiZmVhdHVyZVN0YXJ0IiwiRGF0ZSIsImVtaXQiLCJ1aWQiLCJnZXRVbmlxdWVJZGVudGlmaWVyIiwidGl0bGUiLCJnZXRUaXRsZSIsInR5cGUiLCJmaWxlIiwidGFncyIsImRlc2NyaXB0aW9uIiwia2V5d29yZCIsInNjZW5hcmlvIiwic2NlbmFyaW9TdGFydCIsInRlc3RTdGFydCIsInBhcmVudCIsInN0ZXAiLCJzb3VyY2VMb2NhdGlvbiIsInRleHQiLCJkdXJhdGlvbiIsImZlYXR1cmVOYW1lIiwibmFtZSIsInNjZW5hcmlvTmFtZSIsImFyZ3VtZW50IiwicmVzdWx0IiwiZSIsInN0YXR1cyIsIlN0YXR1cyIsIkZBSUxFRCIsIlVOREVGSU5FRCIsIlBBU1NFRCIsIlBFTkRJTkciLCJTS0lQUEVEIiwiQU1CSUdVT1VTIiwiZXJyb3IiLCJzdGVwVGl0bGUiLCJpZ25vcmVVbmRlZmluZWREZWZpbml0aW9ucyIsIm1lc3NhZ2UiLCJzdGFjayIsImxpbmUiLCJlcnIiLCJleGNlcHRpb24iLCJFcnJvciIsImZhaWxBbWJpZ3VvdXNEZWZpbml0aW9ucyIsInBheWxvYWQiLCJ0cmltIiwiZXZlbnQiLCJmb3JtYXRNZXNzYWdlIiwiZmVhdHVyZU9yU2NlbmFyaW8iLCJsZW5ndGgiLCJtYXAiLCJ0YWciLCJqb2luIiwiZ2V0VXJpT2YiLCJyZXBsYWNlIiwicHJvY2VzcyIsImN3ZCIsInRhcmdldCIsInBhdGgiLCJiYXNlbmFtZSIsImxvY2F0aW9uIiwiZXhhbXBsZXMiLCJ0YWJsZUhlYWRlciIsImNlbGxzIiwiZm9yRWFjaCIsImhlYWRlciIsImlkeCIsImluZGV4T2YiLCJ2YWx1ZSIsInRhYmxlQm9keSIsInRhYmxlRW50cnkiLCJsb2NhdGlvbnMiLCJwYXJhbXMiLCJtYXRjaCIsImZ1bGxUaXRsZSIsInBlbmRpbmciLCJjdHgiLCJjdXJyZW50VGVzdCIsInBhc3NlZCIsInN0YXRlIiwiY29udGV4dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLGdCQUFOLENBQXVCO0FBR25CQyxFQUFBQSxXQUFXLENBQUVDLGdCQUFGLEVBQW9CQyxPQUFwQixFQUE2QkMsR0FBN0IsRUFBa0NDLEtBQWxDLEVBQXlDQyxRQUF6QyxFQUFtRDtBQUFBLDhDQUYzQyxFQUUyQzs7QUFDMUQsU0FBS0MsWUFBTCxHQUFvQkosT0FBTyxDQUFDSSxZQUE1QjtBQUNBLFNBQUtDLFdBQUwsR0FBbUJMLE9BQU8sQ0FBQ0ssV0FBUixJQUF1QixLQUExQztBQUNBLFNBQUtMLE9BQUwsR0FBZUEsT0FBZjtBQUNBLFNBQUtDLEdBQUwsR0FBV0EsR0FBWDtBQUNBLFNBQUtDLEtBQUwsR0FBYUEsS0FBYjtBQUNBLFNBQUtDLFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0EsU0FBS0csV0FBTCxHQUFtQixDQUFuQjtBQUVBLFFBQUlDLDRDQUFKLENBQTBCUixnQkFBMUIsRUFDS1MsRUFETCxDQUNRLGdCQURSLEVBQzBCLEtBQUtDLG1CQUFMLENBQXlCQyxJQUF6QixDQUE4QixJQUE5QixDQUQxQixFQUVLRixFQUZMLENBRVEsaUJBRlIsRUFFMkIsS0FBS0csb0JBQUwsQ0FBMEJELElBQTFCLENBQStCLElBQS9CLENBRjNCLEVBR0tGLEVBSEwsQ0FHUSxhQUhSLEVBR3VCLEtBQUtJLGdCQUFMLENBQXNCRixJQUF0QixDQUEyQixJQUEzQixDQUh2QixFQUlLRixFQUpMLENBSVEsWUFKUixFQUlzQixLQUFLSyxlQUFMLENBQXFCSCxJQUFyQixDQUEwQixJQUExQixDQUp0QixFQUtLRixFQUxMLENBS1EsZ0JBTFIsRUFLMEIsS0FBS00sbUJBQUwsQ0FBeUJKLElBQXpCLENBQThCLElBQTlCLENBTDFCLEVBTUtGLEVBTkwsQ0FNUSxlQU5SLEVBTXlCLEtBQUtPLGtCQUFMLENBQXdCTCxJQUF4QixDQUE2QixJQUE3QixDQU56QjtBQU9IOztBQUVERCxFQUFBQSxtQkFBbUIsQ0FBRU8sR0FBRixFQUFPQyxPQUFQLEVBQWdCO0FBQy9CLFNBQUtDLFlBQUwsR0FBb0IsSUFBSUMsSUFBSixFQUFwQjtBQUVBLFNBQUtDLElBQUwsQ0FBVSxhQUFWLEVBQXlCO0FBQ3JCQyxNQUFBQSxHQUFHLEVBQUUsS0FBS0MsbUJBQUwsQ0FBeUJMLE9BQXpCLENBRGdCO0FBRXJCTSxNQUFBQSxLQUFLLEVBQUUsS0FBS0MsUUFBTCxDQUFjUCxPQUFkLENBRmM7QUFHckJRLE1BQUFBLElBQUksRUFBRSxPQUhlO0FBSXJCQyxNQUFBQSxJQUFJLEVBQUVWLEdBSmU7QUFLckJXLE1BQUFBLElBQUksRUFBRVYsT0FBTyxDQUFDVSxJQUxPO0FBTXJCQyxNQUFBQSxXQUFXLEVBQUVYLE9BQU8sQ0FBQ1csV0FOQTtBQU9yQkMsTUFBQUEsT0FBTyxFQUFFWixPQUFPLENBQUNZO0FBUEksS0FBekI7QUFTSDs7QUFFRGxCLEVBQUFBLG9CQUFvQixDQUFFSyxHQUFGLEVBQU9DLE9BQVAsRUFBZ0JhLFFBQWhCLEVBQTBCO0FBQzFDLFNBQUtDLGFBQUwsR0FBcUIsSUFBSVosSUFBSixFQUFyQjtBQUNBLFNBQUthLFNBQUwsR0FBaUIsSUFBSWIsSUFBSixFQUFqQjtBQUVBLFNBQUtDLElBQUwsQ0FBVSxhQUFWLEVBQXlCO0FBQ3JCQyxNQUFBQSxHQUFHLEVBQUUsS0FBS0MsbUJBQUwsQ0FBeUJRLFFBQXpCLENBRGdCO0FBRXJCUCxNQUFBQSxLQUFLLEVBQUUsS0FBS0MsUUFBTCxDQUFjTSxRQUFkLENBRmM7QUFHckJHLE1BQUFBLE1BQU0sRUFBRSxLQUFLWCxtQkFBTCxDQUF5QkwsT0FBekIsQ0FIYTtBQUlyQlEsTUFBQUEsSUFBSSxFQUFFLE9BSmU7QUFLckJDLE1BQUFBLElBQUksRUFBRVYsR0FMZTtBQU1yQlcsTUFBQUEsSUFBSSxFQUFFRyxRQUFRLENBQUNIO0FBTk0sS0FBekI7QUFRSDs7QUFFRGYsRUFBQUEsZ0JBQWdCLENBQUVJLEdBQUYsRUFBT0MsT0FBUCxFQUFnQmEsUUFBaEIsRUFBMEJJLElBQTFCLEVBQWdDQyxjQUFoQyxFQUFnRDtBQUM1RCxTQUFLSCxTQUFMLEdBQWlCLElBQUliLElBQUosRUFBakI7QUFFQSxTQUFLQyxJQUFMLENBQVUsWUFBVixFQUF3QjtBQUNwQkMsTUFBQUEsR0FBRyxFQUFFLEtBQUtDLG1CQUFMLENBQXlCWSxJQUF6QixDQURlO0FBRXBCWCxNQUFBQSxLQUFLLEVBQUVXLElBQUksQ0FBQ0UsSUFGUTtBQUdwQlgsTUFBQUEsSUFBSSxFQUFFLE1BSGM7QUFJcEJDLE1BQUFBLElBQUksRUFBRVYsR0FKYztBQUtwQmlCLE1BQUFBLE1BQU0sRUFBRSxLQUFLWCxtQkFBTCxDQUF5QlEsUUFBekIsRUFBbUNLLGNBQW5DLENBTFk7QUFNcEJFLE1BQUFBLFFBQVEsRUFBRSxJQUFJbEIsSUFBSixLQUFhLEtBQUthLFNBTlI7QUFPcEJMLE1BQUFBLElBQUksRUFBRUcsUUFBUSxDQUFDSCxJQVBLO0FBUXBCVyxNQUFBQSxXQUFXLEVBQUVyQixPQUFPLENBQUNzQixJQVJEO0FBU3BCQyxNQUFBQSxZQUFZLEVBQUVWLFFBQVEsQ0FBQ1MsSUFUSDtBQVVwQkUsTUFBQUEsUUFBUSxFQUFFLCtCQUFtQlAsSUFBbkI7QUFWVSxLQUF4QjtBQVlIOztBQUVEckIsRUFBQUEsZUFBZSxDQUFFRyxHQUFGLEVBQU9DLE9BQVAsRUFBZ0JhLFFBQWhCLEVBQTBCSSxJQUExQixFQUFnQ1EsTUFBaEMsRUFBd0NQLGNBQXhDLEVBQXdEO0FBQ25FLFFBQUlRLENBQUMsR0FBRyxXQUFSOztBQUNBLFlBQVFELE1BQU0sQ0FBQ0UsTUFBZjtBQUNBLFdBQUtDLGlCQUFPQyxNQUFaO0FBQ0EsV0FBS0QsaUJBQU9FLFNBQVo7QUFDSUosUUFBQUEsQ0FBQyxHQUFHLE1BQUo7QUFDQTs7QUFDSixXQUFLRSxpQkFBT0csTUFBWjtBQUNJTCxRQUFBQSxDQUFDLEdBQUcsTUFBSjtBQUNBOztBQUNKLFdBQUtFLGlCQUFPSSxPQUFaO0FBQ0EsV0FBS0osaUJBQU9LLE9BQVo7QUFDQSxXQUFLTCxpQkFBT00sU0FBWjtBQUNJUixRQUFBQSxDQUFDLEdBQUcsU0FBSjtBQVhKOztBQWFBLFFBQUlTLEtBQUssR0FBRyxFQUFaO0FBQ0EsUUFBSUMsU0FBUyxHQUFHbkIsSUFBSSxDQUFDRSxJQUFMLElBQWFGLElBQUksQ0FBQ0wsT0FBbEIsSUFBNkIsZ0JBQTdDO0FBRUE7Ozs7O0FBSUEsUUFBSSxDQUFDSyxJQUFJLENBQUNFLElBQU4sSUFBY00sTUFBTSxDQUFDRSxNQUFQLEtBQWtCQyxpQkFBT0MsTUFBM0MsRUFBbUQ7QUFDL0M7QUFDSDs7QUFFRCxRQUFJSixNQUFNLENBQUNFLE1BQVAsS0FBa0JDLGlCQUFPRSxTQUE3QixFQUF3QztBQUNwQyxVQUFJLEtBQUsvQyxPQUFMLENBQWFzRCwwQkFBakIsRUFBNkM7QUFDekM7OztBQUdBWCxRQUFBQSxDQUFDLEdBQUcsU0FBSjtBQUNBVSxRQUFBQSxTQUFTLElBQUksbUJBQWI7QUFDSCxPQU5ELE1BTU87QUFDSDs7O0FBR0EsYUFBSy9DLFdBQUw7QUFFQThDLFFBQUFBLEtBQUssR0FBRztBQUNKRyxVQUFBQSxPQUFPLEVBQUcsU0FBUUYsU0FBVTsrRUFEeEI7QUFHSkcsVUFBQUEsS0FBSyxFQUFHLEdBQUV0QixJQUFJLENBQUNsQixHQUFJLElBQUdrQixJQUFJLENBQUN1QixJQUFLO0FBSDVCLFNBQVI7QUFLSDtBQUNKLEtBbkJELE1BbUJPLElBQUlmLE1BQU0sQ0FBQ0UsTUFBUCxLQUFrQkMsaUJBQU9DLE1BQTdCLEVBQXFDO0FBQ3hDOzs7O0FBSUEsVUFBSVksR0FBRyxHQUFHaEIsTUFBTSxDQUFDaUIsU0FBakI7O0FBQ0EsVUFBSUQsR0FBRyxZQUFZRSxLQUFuQixFQUEwQjtBQUN0QlIsUUFBQUEsS0FBSyxHQUFHO0FBQ0pHLFVBQUFBLE9BQU8sRUFBRUcsR0FBRyxDQUFDSCxPQURUO0FBRUpDLFVBQUFBLEtBQUssRUFBRUUsR0FBRyxDQUFDRjtBQUZQLFNBQVI7QUFJSCxPQUxELE1BS087QUFDSEosUUFBQUEsS0FBSyxHQUFHO0FBQ0pHLFVBQUFBLE9BQU8sRUFBRUc7QUFETCxTQUFSO0FBR0g7O0FBQ0QsV0FBS3BELFdBQUw7QUFDSCxLQWpCTSxNQWlCQSxJQUFJb0MsTUFBTSxDQUFDRSxNQUFQLEtBQWtCQyxpQkFBT00sU0FBekIsSUFBc0MsS0FBS25ELE9BQUwsQ0FBYTZELHdCQUF2RCxFQUFpRjtBQUNwRmxCLE1BQUFBLENBQUMsR0FBRyxNQUFKO0FBQ0EsV0FBS3JDLFdBQUw7QUFDQThDLE1BQUFBLEtBQUssR0FBRztBQUNKRyxRQUFBQSxPQUFPLEVBQUViLE1BQU0sQ0FBQ2lCO0FBRFosT0FBUjtBQUdIOztBQUVELFVBQU1HLE9BQU8sR0FBRztBQUNaekMsTUFBQUEsR0FBRyxFQUFFLEtBQUtDLG1CQUFMLENBQXlCWSxJQUF6QixDQURPO0FBRVpYLE1BQUFBLEtBQUssRUFBRThCLFNBQVMsQ0FBQ1UsSUFBVixFQUZLO0FBR1p0QyxNQUFBQSxJQUFJLEVBQUUsTUFITTtBQUlaQyxNQUFBQSxJQUFJLEVBQUVWLEdBSk07QUFLWmlCLE1BQUFBLE1BQU0sRUFBRSxLQUFLWCxtQkFBTCxDQUF5QlEsUUFBekIsRUFBbUNLLGNBQW5DLENBTEk7QUFNWmlCLE1BQUFBLEtBQUssRUFBRUEsS0FOSztBQU9aZixNQUFBQSxRQUFRLEVBQUUsSUFBSWxCLElBQUosS0FBYSxLQUFLYSxTQVBoQjtBQVFaTCxNQUFBQSxJQUFJLEVBQUVHLFFBQVEsQ0FBQ0gsSUFSSDtBQVNaRSxNQUFBQSxPQUFPLEVBQUVLLElBQUksQ0FBQ0wsT0FURjtBQVVaWSxNQUFBQSxRQUFRLEVBQUUsK0JBQW1CUCxJQUFuQjtBQVZFLEtBQWhCO0FBYUEsU0FBS2QsSUFBTCxDQUFVLFVBQVV1QixDQUFwQixFQUF1Qm1CLE9BQXZCO0FBQ0g7O0FBRURoRCxFQUFBQSxtQkFBbUIsQ0FBRUUsR0FBRixFQUFPQyxPQUFQLEVBQWdCYSxRQUFoQixFQUEwQkssY0FBMUIsRUFBMEM7QUFDekQsU0FBS2YsSUFBTCxDQUFVLFdBQVYsRUFBdUI7QUFDbkJDLE1BQUFBLEdBQUcsRUFBRSxLQUFLQyxtQkFBTCxDQUF5QlEsUUFBekIsRUFBbUNLLGNBQW5DLENBRGM7QUFFbkJaLE1BQUFBLEtBQUssRUFBRSxLQUFLQyxRQUFMLENBQWNNLFFBQWQsQ0FGWTtBQUduQkcsTUFBQUEsTUFBTSxFQUFFLEtBQUtYLG1CQUFMLENBQXlCTCxPQUF6QixDQUhXO0FBSW5CUSxNQUFBQSxJQUFJLEVBQUUsT0FKYTtBQUtuQkMsTUFBQUEsSUFBSSxFQUFFVixHQUxhO0FBTW5CcUIsTUFBQUEsUUFBUSxFQUFFLElBQUlsQixJQUFKLEtBQWEsS0FBS1ksYUFOVDtBQU9uQkosTUFBQUEsSUFBSSxFQUFFRyxRQUFRLENBQUNIO0FBUEksS0FBdkI7QUFTSDs7QUFFRFosRUFBQUEsa0JBQWtCLENBQUVDLEdBQUYsRUFBT0MsT0FBUCxFQUFnQjtBQUM5QixTQUFLRyxJQUFMLENBQVUsV0FBVixFQUF1QjtBQUNuQkMsTUFBQUEsR0FBRyxFQUFFLEtBQUtDLG1CQUFMLENBQXlCTCxPQUF6QixDQURjO0FBRW5CTSxNQUFBQSxLQUFLLEVBQUUsS0FBS0MsUUFBTCxDQUFjUCxPQUFkLENBRlk7QUFHbkJRLE1BQUFBLElBQUksRUFBRSxPQUhhO0FBSW5CQyxNQUFBQSxJQUFJLEVBQUVWLEdBSmE7QUFLbkJxQixNQUFBQSxRQUFRLEVBQUUsSUFBSWxCLElBQUosS0FBYSxLQUFLRCxZQUxUO0FBTW5CUyxNQUFBQSxJQUFJLEVBQUVWLE9BQU8sQ0FBQ1U7QUFOSyxLQUF2QjtBQVFIOztBQUVEUCxFQUFBQSxJQUFJLENBQUU0QyxLQUFGLEVBQVNGLE9BQVQsRUFBa0I7QUFDbEIsUUFBSVAsT0FBTyxHQUFHLEtBQUtVLGFBQUwsQ0FBbUI7QUFBRXhDLE1BQUFBLElBQUksRUFBRXVDLEtBQVI7QUFBZUYsTUFBQUE7QUFBZixLQUFuQixDQUFkO0FBRUFQLElBQUFBLE9BQU8sQ0FBQ3RELEdBQVIsR0FBYyxLQUFLQSxHQUFuQjtBQUNBc0QsSUFBQUEsT0FBTyxDQUFDckQsS0FBUixHQUFnQixLQUFLQSxLQUFyQjtBQUNBcUQsSUFBQUEsT0FBTyxDQUFDbEMsR0FBUixHQUFjeUMsT0FBTyxDQUFDekMsR0FBdEI7QUFFQSxTQUFLbEIsUUFBTCxDQUFjaUIsSUFBZCxDQUFtQm1DLE9BQU8sQ0FBQzlCLElBQTNCLEVBQWlDOEIsT0FBakM7QUFDSDs7QUFFRC9CLEVBQUFBLFFBQVEsQ0FBRTBDLGlCQUFGLEVBQXFCO0FBQ3pCLFVBQU0zQixJQUFJLEdBQUcyQixpQkFBaUIsQ0FBQzNCLElBQS9CO0FBQ0EsVUFBTVosSUFBSSxHQUFHdUMsaUJBQWlCLENBQUN2QyxJQUEvQjtBQUNBLFFBQUksQ0FBQyxLQUFLdEIsV0FBTixJQUFxQixDQUFDc0IsSUFBSSxDQUFDd0MsTUFBL0IsRUFBdUMsT0FBTzVCLElBQVA7QUFDdkMsV0FBUSxHQUFFWixJQUFJLENBQUN5QyxHQUFMLENBQVNDLEdBQUcsSUFBSUEsR0FBRyxDQUFDOUIsSUFBcEIsRUFBMEIrQixJQUExQixDQUErQixJQUEvQixDQUFxQyxLQUFJL0IsSUFBSyxFQUF4RDtBQUNIOztBQUVEZ0MsRUFBQUEsUUFBUSxDQUFFOUMsSUFBRixFQUFRO0FBQ1osUUFBSSxDQUFDQSxJQUFELElBQVMsQ0FBQ0EsSUFBSSxDQUFDVCxHQUFuQixFQUF3QjtBQUNwQjtBQUNIOztBQUVELFdBQU9TLElBQUksQ0FBQ1QsR0FBTCxDQUFTd0QsT0FBVCxDQUFpQkMsT0FBTyxDQUFDQyxHQUFSLEVBQWpCLEVBQWdDLEVBQWhDLENBQVA7QUFDSDs7QUFFRHBELEVBQUFBLG1CQUFtQixDQUFFcUQsTUFBRixFQUFVeEMsY0FBVixFQUEwQjtBQUN6QyxRQUFJSSxJQUFKO0FBQ0EsUUFBSWtCLElBQUo7O0FBRUEsUUFBSWtCLE1BQU0sQ0FBQ2xELElBQVAsS0FBZ0IsTUFBcEIsRUFBNEI7QUFDeEJjLE1BQUFBLElBQUksR0FBR3FDLElBQUksQ0FBQ0MsUUFBTCxDQUFjRixNQUFNLENBQUNHLFFBQVAsQ0FBZ0I5RCxHQUE5QixDQUFQO0FBQ0F5QyxNQUFBQSxJQUFJLEdBQUdrQixNQUFNLENBQUNHLFFBQVAsQ0FBZ0JyQixJQUF2QjtBQUNILEtBSEQsTUFHTyxJQUFJa0IsTUFBTSxDQUFDbEQsSUFBUCxLQUFnQixpQkFBcEIsRUFBdUM7QUFDMUNjLE1BQUFBLElBQUksR0FBR29DLE1BQU0sQ0FBQ3BDLElBQVAsSUFBZW9DLE1BQU0sQ0FBQ3ZDLElBQTdCO0FBQ0FxQixNQUFBQSxJQUFJLEdBQUd0QixjQUFjLENBQUNzQixJQUF0QjtBQUVBa0IsTUFBQUEsTUFBTSxDQUFDSSxRQUFQLENBQWdCLENBQWhCLEVBQW1CQyxXQUFuQixDQUErQkMsS0FBL0IsQ0FBcUNDLE9BQXJDLENBQTZDLENBQUNDLE1BQUQsRUFBU0MsR0FBVCxLQUFpQjtBQUMxRCxZQUFJN0MsSUFBSSxDQUFDOEMsT0FBTCxDQUFhLE1BQU1GLE1BQU0sQ0FBQ0csS0FBYixHQUFxQixHQUFsQyxJQUF5QyxDQUFDLENBQTlDLEVBQWlEO0FBQzdDWCxVQUFBQSxNQUFNLENBQUNJLFFBQVAsQ0FBZ0IsQ0FBaEIsRUFBbUJRLFNBQW5CLENBQTZCTCxPQUE3QixDQUFzQ00sVUFBRCxJQUFnQjtBQUNqRCxnQkFBSUEsVUFBVSxDQUFDVixRQUFYLENBQW9CckIsSUFBcEIsS0FBNkJ0QixjQUFjLENBQUNzQixJQUFoRCxFQUFzRDtBQUNsRGxCLGNBQUFBLElBQUksR0FBR0EsSUFBSSxDQUFDaUMsT0FBTCxDQUFhLE1BQU1XLE1BQU0sQ0FBQ0csS0FBYixHQUFxQixHQUFsQyxFQUF1Q0UsVUFBVSxDQUFDUCxLQUFYLENBQWlCRyxHQUFqQixFQUFzQkUsS0FBN0QsQ0FBUDtBQUNIO0FBQ0osV0FKRDtBQUtIO0FBQ0osT0FSRDtBQVNILEtBYk0sTUFhQTtBQUNIL0MsTUFBQUEsSUFBSSxHQUFHb0MsTUFBTSxDQUFDcEMsSUFBUCxJQUFlb0MsTUFBTSxDQUFDdkMsSUFBN0I7QUFDQSxZQUFNMEMsUUFBUSxHQUFHSCxNQUFNLENBQUNHLFFBQVAsSUFBbUJILE1BQU0sQ0FBQ2MsU0FBUCxDQUFpQixDQUFqQixDQUFwQztBQUNBaEMsTUFBQUEsSUFBSSxHQUFJcUIsUUFBUSxJQUFJQSxRQUFRLENBQUNyQixJQUF0QixJQUErQixFQUF0QztBQUNIOztBQUVELFdBQU9sQixJQUFJLEdBQUdrQixJQUFkO0FBQ0g7O0FBRURRLEVBQUFBLGFBQWEsQ0FBRXlCLE1BQUYsRUFBVTtBQUNuQixRQUFJbkMsT0FBTyxHQUFHO0FBQ1Y5QixNQUFBQSxJQUFJLEVBQUVpRSxNQUFNLENBQUNqRTtBQURILEtBQWQ7O0FBSUEsUUFBSWlFLE1BQU0sQ0FBQzVCLE9BQVAsSUFBa0I0QixNQUFNLENBQUM1QixPQUFQLENBQWVWLEtBQXJDLEVBQTRDO0FBQ3hDRyxNQUFBQSxPQUFPLENBQUNILEtBQVIsR0FBZ0JzQyxNQUFNLENBQUM1QixPQUFQLENBQWVWLEtBQS9CO0FBRUE7Ozs7QUFHQSxVQUFJc0MsTUFBTSxDQUFDNUIsT0FBUCxDQUFldkMsS0FBZixJQUF3Qm1FLE1BQU0sQ0FBQzVCLE9BQVAsQ0FBZXZDLEtBQWYsQ0FBcUJvRSxLQUFyQixDQUEyQixnQ0FBM0IsQ0FBNUIsRUFBMEY7QUFDdEZwQyxRQUFBQSxPQUFPLENBQUM5QixJQUFSLEdBQWUsVUFBZjtBQUNIO0FBQ0o7O0FBRUQsUUFBSWlFLE1BQU0sQ0FBQzVCLE9BQVgsRUFBb0I7QUFDaEJQLE1BQUFBLE9BQU8sQ0FBQ2hDLEtBQVIsR0FBZ0JtRSxNQUFNLENBQUM1QixPQUFQLENBQWV2QyxLQUEvQjtBQUNBZ0MsTUFBQUEsT0FBTyxDQUFDdEIsTUFBUixHQUFpQnlELE1BQU0sQ0FBQzVCLE9BQVAsQ0FBZTdCLE1BQWYsR0FBd0J5RCxNQUFNLENBQUM1QixPQUFQLENBQWU3QixNQUFmLENBQXNCVixLQUE5QyxHQUFzRCxJQUF2RTtBQUVBZ0MsTUFBQUEsT0FBTyxDQUFDcUMsU0FBUixHQUFvQkYsTUFBTSxDQUFDNUIsT0FBUCxDQUFlOEIsU0FBZixHQUEyQkYsTUFBTSxDQUFDNUIsT0FBUCxDQUFlOEIsU0FBZixFQUEzQixHQUF3RHJDLE9BQU8sQ0FBQ3RCLE1BQVIsR0FBaUIsR0FBakIsR0FBdUJzQixPQUFPLENBQUNoQyxLQUEzRztBQUNBZ0MsTUFBQUEsT0FBTyxDQUFDc0MsT0FBUixHQUFrQkgsTUFBTSxDQUFDNUIsT0FBUCxDQUFlK0IsT0FBZixJQUEwQixLQUE1QztBQUNBdEMsTUFBQUEsT0FBTyxDQUFDN0IsSUFBUixHQUFlZ0UsTUFBTSxDQUFDNUIsT0FBUCxDQUFlcEMsSUFBOUI7QUFDQTZCLE1BQUFBLE9BQU8sQ0FBQ2xCLFFBQVIsR0FBbUJxRCxNQUFNLENBQUM1QixPQUFQLENBQWV6QixRQUFsQztBQUVBOzs7OztBQUlBLFVBQUlxRCxNQUFNLENBQUM1QixPQUFQLENBQWVnQyxHQUFmLElBQXNCSixNQUFNLENBQUM1QixPQUFQLENBQWVnQyxHQUFmLENBQW1CQyxXQUE3QyxFQUEwRDtBQUN0RHhDLFFBQUFBLE9BQU8sQ0FBQ3dDLFdBQVIsR0FBc0JMLE1BQU0sQ0FBQzVCLE9BQVAsQ0FBZWdDLEdBQWYsQ0FBbUJDLFdBQW5CLENBQStCeEUsS0FBckQ7QUFDSDs7QUFFRCxVQUFJbUUsTUFBTSxDQUFDakUsSUFBUCxDQUFZa0UsS0FBWixDQUFrQixNQUFsQixDQUFKLEVBQStCO0FBQzNCcEMsUUFBQUEsT0FBTyxDQUFDeUMsTUFBUixHQUFrQk4sTUFBTSxDQUFDNUIsT0FBUCxDQUFlbUMsS0FBZixLQUF5QixRQUEzQztBQUNIOztBQUVELFVBQUlQLE1BQU0sQ0FBQzVCLE9BQVAsQ0FBZW9DLE9BQW5CLEVBQTRCO0FBQUUzQyxRQUFBQSxPQUFPLENBQUMyQyxPQUFSLEdBQWtCUixNQUFNLENBQUM1QixPQUFQLENBQWVvQyxPQUFqQztBQUEwQztBQUMzRTs7QUFFRCxXQUFPM0MsT0FBUDtBQUNIOztBQTlRa0I7O2VBaVJSMUQsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdGF0dXMgfSBmcm9tICdjdWN1bWJlcidcbmltcG9ydCB7IEN1Y3VtYmVyRXZlbnRMaXN0ZW5lciB9IGZyb20gJy4vQ3VjdW1iZXJFdmVudExpc3RlbmVyJ1xuaW1wb3J0IHsgY3JlYXRlU3RlcEFyZ3VtZW50IH0gZnJvbSAnLi91dGlscydcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcblxuY2xhc3MgQ3VjdW1iZXJSZXBvcnRlciB7XG4gICAgZ2hlcmtpbkRvY0V2ZW50cyA9IFtdXG5cbiAgICBjb25zdHJ1Y3RvciAoZXZlbnRCcm9hZGNhc3Rlciwgb3B0aW9ucywgY2lkLCBzcGVjcywgcmVwb3J0ZXIpIHtcbiAgICAgICAgdGhpcy5jYXBhYmlsaXRpZXMgPSBvcHRpb25zLmNhcGFiaWxpdGllc1xuICAgICAgICB0aGlzLnRhZ3NJblRpdGxlID0gb3B0aW9ucy50YWdzSW5UaXRsZSB8fCBmYWxzZVxuICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zXG4gICAgICAgIHRoaXMuY2lkID0gY2lkXG4gICAgICAgIHRoaXMuc3BlY3MgPSBzcGVjc1xuICAgICAgICB0aGlzLnJlcG9ydGVyID0gcmVwb3J0ZXJcbiAgICAgICAgdGhpcy5mYWlsZWRDb3VudCA9IDBcblxuICAgICAgICBuZXcgQ3VjdW1iZXJFdmVudExpc3RlbmVyKGV2ZW50QnJvYWRjYXN0ZXIpXG4gICAgICAgICAgICAub24oJ2JlZm9yZS1mZWF0dXJlJywgdGhpcy5oYW5kbGVCZWZvcmVGZWF0dXJlLmJpbmQodGhpcykpXG4gICAgICAgICAgICAub24oJ2JlZm9yZS1zY2VuYXJpbycsIHRoaXMuaGFuZGxlQmVmb3JlU2NlbmFyaW8uYmluZCh0aGlzKSlcbiAgICAgICAgICAgIC5vbignYmVmb3JlLXN0ZXAnLCB0aGlzLmhhbmRsZUJlZm9yZVN0ZXAuYmluZCh0aGlzKSlcbiAgICAgICAgICAgIC5vbignYWZ0ZXItc3RlcCcsIHRoaXMuaGFuZGxlQWZ0ZXJTdGVwLmJpbmQodGhpcykpXG4gICAgICAgICAgICAub24oJ2FmdGVyLXNjZW5hcmlvJywgdGhpcy5oYW5kbGVBZnRlclNjZW5hcmlvLmJpbmQodGhpcykpXG4gICAgICAgICAgICAub24oJ2FmdGVyLWZlYXR1cmUnLCB0aGlzLmhhbmRsZUFmdGVyRmVhdHVyZS5iaW5kKHRoaXMpKVxuICAgIH1cblxuICAgIGhhbmRsZUJlZm9yZUZlYXR1cmUgKHVyaSwgZmVhdHVyZSkge1xuICAgICAgICB0aGlzLmZlYXR1cmVTdGFydCA9IG5ldyBEYXRlKClcblxuICAgICAgICB0aGlzLmVtaXQoJ3N1aXRlOnN0YXJ0Jywge1xuICAgICAgICAgICAgdWlkOiB0aGlzLmdldFVuaXF1ZUlkZW50aWZpZXIoZmVhdHVyZSksXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5nZXRUaXRsZShmZWF0dXJlKSxcbiAgICAgICAgICAgIHR5cGU6ICdzdWl0ZScsXG4gICAgICAgICAgICBmaWxlOiB1cmksXG4gICAgICAgICAgICB0YWdzOiBmZWF0dXJlLnRhZ3MsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogZmVhdHVyZS5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgIGtleXdvcmQ6IGZlYXR1cmUua2V5d29yZFxuICAgICAgICB9KVxuICAgIH1cblxuICAgIGhhbmRsZUJlZm9yZVNjZW5hcmlvICh1cmksIGZlYXR1cmUsIHNjZW5hcmlvKSB7XG4gICAgICAgIHRoaXMuc2NlbmFyaW9TdGFydCA9IG5ldyBEYXRlKClcbiAgICAgICAgdGhpcy50ZXN0U3RhcnQgPSBuZXcgRGF0ZSgpXG5cbiAgICAgICAgdGhpcy5lbWl0KCdzdWl0ZTpzdGFydCcsIHtcbiAgICAgICAgICAgIHVpZDogdGhpcy5nZXRVbmlxdWVJZGVudGlmaWVyKHNjZW5hcmlvKSxcbiAgICAgICAgICAgIHRpdGxlOiB0aGlzLmdldFRpdGxlKHNjZW5hcmlvKSxcbiAgICAgICAgICAgIHBhcmVudDogdGhpcy5nZXRVbmlxdWVJZGVudGlmaWVyKGZlYXR1cmUpLFxuICAgICAgICAgICAgdHlwZTogJ3N1aXRlJyxcbiAgICAgICAgICAgIGZpbGU6IHVyaSxcbiAgICAgICAgICAgIHRhZ3M6IHNjZW5hcmlvLnRhZ3NcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBoYW5kbGVCZWZvcmVTdGVwICh1cmksIGZlYXR1cmUsIHNjZW5hcmlvLCBzdGVwLCBzb3VyY2VMb2NhdGlvbikge1xuICAgICAgICB0aGlzLnRlc3RTdGFydCA9IG5ldyBEYXRlKClcblxuICAgICAgICB0aGlzLmVtaXQoJ3Rlc3Q6c3RhcnQnLCB7XG4gICAgICAgICAgICB1aWQ6IHRoaXMuZ2V0VW5pcXVlSWRlbnRpZmllcihzdGVwKSxcbiAgICAgICAgICAgIHRpdGxlOiBzdGVwLnRleHQsXG4gICAgICAgICAgICB0eXBlOiAndGVzdCcsXG4gICAgICAgICAgICBmaWxlOiB1cmksXG4gICAgICAgICAgICBwYXJlbnQ6IHRoaXMuZ2V0VW5pcXVlSWRlbnRpZmllcihzY2VuYXJpbywgc291cmNlTG9jYXRpb24pLFxuICAgICAgICAgICAgZHVyYXRpb246IG5ldyBEYXRlKCkgLSB0aGlzLnRlc3RTdGFydCxcbiAgICAgICAgICAgIHRhZ3M6IHNjZW5hcmlvLnRhZ3MsXG4gICAgICAgICAgICBmZWF0dXJlTmFtZTogZmVhdHVyZS5uYW1lLFxuICAgICAgICAgICAgc2NlbmFyaW9OYW1lOiBzY2VuYXJpby5uYW1lLFxuICAgICAgICAgICAgYXJndW1lbnQ6IGNyZWF0ZVN0ZXBBcmd1bWVudChzdGVwKVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIGhhbmRsZUFmdGVyU3RlcCAodXJpLCBmZWF0dXJlLCBzY2VuYXJpbywgc3RlcCwgcmVzdWx0LCBzb3VyY2VMb2NhdGlvbikge1xuICAgICAgICBsZXQgZSA9ICd1bmRlZmluZWQnXG4gICAgICAgIHN3aXRjaCAocmVzdWx0LnN0YXR1cykge1xuICAgICAgICBjYXNlIFN0YXR1cy5GQUlMRUQ6XG4gICAgICAgIGNhc2UgU3RhdHVzLlVOREVGSU5FRDpcbiAgICAgICAgICAgIGUgPSAnZmFpbCdcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgU3RhdHVzLlBBU1NFRDpcbiAgICAgICAgICAgIGUgPSAncGFzcydcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgU3RhdHVzLlBFTkRJTkc6XG4gICAgICAgIGNhc2UgU3RhdHVzLlNLSVBQRUQ6XG4gICAgICAgIGNhc2UgU3RhdHVzLkFNQklHVU9VUzpcbiAgICAgICAgICAgIGUgPSAncGVuZGluZydcbiAgICAgICAgfVxuICAgICAgICBsZXQgZXJyb3IgPSB7fVxuICAgICAgICBsZXQgc3RlcFRpdGxlID0gc3RlcC50ZXh0IHx8IHN0ZXAua2V5d29yZCB8fCAnVW5kZWZpbmVkIFN0ZXAnXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGlmIHN0ZXAgbmFtZSBpcyB1bmRlZmluZWQgd2UgYXJlIGRlYWxpbmcgd2l0aCBhIGhvb2tcbiAgICAgICAgICogZG9uJ3QgcmVwb3J0IGhvb2tzIGlmIG5vIGVycm9yIGhhcHBlbmVkXG4gICAgICAgICAqL1xuICAgICAgICBpZiAoIXN0ZXAudGV4dCAmJiByZXN1bHQuc3RhdHVzICE9PSBTdGF0dXMuRkFJTEVEKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXN1bHQuc3RhdHVzID09PSBTdGF0dXMuVU5ERUZJTkVEKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmlnbm9yZVVuZGVmaW5lZERlZmluaXRpb25zKSB7XG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogbWFyayB0ZXN0IGFzIHBlbmRpbmdcbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBlID0gJ3BlbmRpbmcnXG4gICAgICAgICAgICAgICAgc3RlcFRpdGxlICs9ICcgKHVuZGVmaW5lZCBzdGVwKSdcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogbWFyayB0ZXN0IGFzIGZhaWxlZFxuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIHRoaXMuZmFpbGVkQ291bnQrK1xuXG4gICAgICAgICAgICAgICAgZXJyb3IgPSB7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBTdGVwIFwiJHtzdGVwVGl0bGV9XCIgaXMgbm90IGRlZmluZWQuIFlvdSBjYW4gaWdub3JlIHRoaXMgZXJyb3IgYnkgc2V0dGluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VjdW1iZXJPcHRzLmlnbm9yZVVuZGVmaW5lZERlZmluaXRpb25zIGFzIHRydWUuYCxcbiAgICAgICAgICAgICAgICAgICAgc3RhY2s6IGAke3N0ZXAudXJpfToke3N0ZXAubGluZX1gXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5zdGF0dXMgPT09IFN0YXR1cy5GQUlMRUQpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogY3VjdW1iZXIgZmFpbHVyZSBleGNlcHRpb24gY2FuJ3QgZ2V0IHNlbmQgdG8gcGFyZW50IHByb2Nlc3NcbiAgICAgICAgICAgICAqIGZvciBzb21lIHJlYXNvbnNcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgbGV0IGVyciA9IHJlc3VsdC5leGNlcHRpb25cbiAgICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgICAgICAgIGVycm9yID0ge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgc3RhY2s6IGVyci5zdGFja1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZXJyb3IgPSB7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVyclxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZmFpbGVkQ291bnQrK1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5zdGF0dXMgPT09IFN0YXR1cy5BTUJJR1VPVVMgJiYgdGhpcy5vcHRpb25zLmZhaWxBbWJpZ3VvdXNEZWZpbml0aW9ucykge1xuICAgICAgICAgICAgZSA9ICdmYWlsJ1xuICAgICAgICAgICAgdGhpcy5mYWlsZWRDb3VudCsrXG4gICAgICAgICAgICBlcnJvciA9IHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiByZXN1bHQuZXhjZXB0aW9uXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXlsb2FkID0ge1xuICAgICAgICAgICAgdWlkOiB0aGlzLmdldFVuaXF1ZUlkZW50aWZpZXIoc3RlcCksXG4gICAgICAgICAgICB0aXRsZTogc3RlcFRpdGxlLnRyaW0oKSxcbiAgICAgICAgICAgIHR5cGU6ICd0ZXN0JyxcbiAgICAgICAgICAgIGZpbGU6IHVyaSxcbiAgICAgICAgICAgIHBhcmVudDogdGhpcy5nZXRVbmlxdWVJZGVudGlmaWVyKHNjZW5hcmlvLCBzb3VyY2VMb2NhdGlvbiksXG4gICAgICAgICAgICBlcnJvcjogZXJyb3IsXG4gICAgICAgICAgICBkdXJhdGlvbjogbmV3IERhdGUoKSAtIHRoaXMudGVzdFN0YXJ0LFxuICAgICAgICAgICAgdGFnczogc2NlbmFyaW8udGFncyxcbiAgICAgICAgICAgIGtleXdvcmQ6IHN0ZXAua2V5d29yZCxcbiAgICAgICAgICAgIGFyZ3VtZW50OiBjcmVhdGVTdGVwQXJndW1lbnQoc3RlcClcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZW1pdCgndGVzdDonICsgZSwgcGF5bG9hZClcbiAgICB9XG5cbiAgICBoYW5kbGVBZnRlclNjZW5hcmlvICh1cmksIGZlYXR1cmUsIHNjZW5hcmlvLCBzb3VyY2VMb2NhdGlvbikge1xuICAgICAgICB0aGlzLmVtaXQoJ3N1aXRlOmVuZCcsIHtcbiAgICAgICAgICAgIHVpZDogdGhpcy5nZXRVbmlxdWVJZGVudGlmaWVyKHNjZW5hcmlvLCBzb3VyY2VMb2NhdGlvbiksXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5nZXRUaXRsZShzY2VuYXJpbyksXG4gICAgICAgICAgICBwYXJlbnQ6IHRoaXMuZ2V0VW5pcXVlSWRlbnRpZmllcihmZWF0dXJlKSxcbiAgICAgICAgICAgIHR5cGU6ICdzdWl0ZScsXG4gICAgICAgICAgICBmaWxlOiB1cmksXG4gICAgICAgICAgICBkdXJhdGlvbjogbmV3IERhdGUoKSAtIHRoaXMuc2NlbmFyaW9TdGFydCxcbiAgICAgICAgICAgIHRhZ3M6IHNjZW5hcmlvLnRhZ3NcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBoYW5kbGVBZnRlckZlYXR1cmUgKHVyaSwgZmVhdHVyZSkge1xuICAgICAgICB0aGlzLmVtaXQoJ3N1aXRlOmVuZCcsIHtcbiAgICAgICAgICAgIHVpZDogdGhpcy5nZXRVbmlxdWVJZGVudGlmaWVyKGZlYXR1cmUpLFxuICAgICAgICAgICAgdGl0bGU6IHRoaXMuZ2V0VGl0bGUoZmVhdHVyZSksXG4gICAgICAgICAgICB0eXBlOiAnc3VpdGUnLFxuICAgICAgICAgICAgZmlsZTogdXJpLFxuICAgICAgICAgICAgZHVyYXRpb246IG5ldyBEYXRlKCkgLSB0aGlzLmZlYXR1cmVTdGFydCxcbiAgICAgICAgICAgIHRhZ3M6IGZlYXR1cmUudGFnc1xuICAgICAgICB9KVxuICAgIH1cblxuICAgIGVtaXQgKGV2ZW50LCBwYXlsb2FkKSB7XG4gICAgICAgIGxldCBtZXNzYWdlID0gdGhpcy5mb3JtYXRNZXNzYWdlKHsgdHlwZTogZXZlbnQsIHBheWxvYWQgfSlcblxuICAgICAgICBtZXNzYWdlLmNpZCA9IHRoaXMuY2lkXG4gICAgICAgIG1lc3NhZ2Uuc3BlY3MgPSB0aGlzLnNwZWNzXG4gICAgICAgIG1lc3NhZ2UudWlkID0gcGF5bG9hZC51aWRcblxuICAgICAgICB0aGlzLnJlcG9ydGVyLmVtaXQobWVzc2FnZS50eXBlLCBtZXNzYWdlKVxuICAgIH1cblxuICAgIGdldFRpdGxlIChmZWF0dXJlT3JTY2VuYXJpbykge1xuICAgICAgICBjb25zdCBuYW1lID0gZmVhdHVyZU9yU2NlbmFyaW8ubmFtZVxuICAgICAgICBjb25zdCB0YWdzID0gZmVhdHVyZU9yU2NlbmFyaW8udGFnc1xuICAgICAgICBpZiAoIXRoaXMudGFnc0luVGl0bGUgfHwgIXRhZ3MubGVuZ3RoKSByZXR1cm4gbmFtZVxuICAgICAgICByZXR1cm4gYCR7dGFncy5tYXAodGFnID0+IHRhZy5uYW1lKS5qb2luKCcsICcpfTogJHtuYW1lfWBcbiAgICB9XG5cbiAgICBnZXRVcmlPZiAodHlwZSkge1xuICAgICAgICBpZiAoIXR5cGUgfHwgIXR5cGUudXJpKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0eXBlLnVyaS5yZXBsYWNlKHByb2Nlc3MuY3dkKCksICcnKVxuICAgIH1cblxuICAgIGdldFVuaXF1ZUlkZW50aWZpZXIgKHRhcmdldCwgc291cmNlTG9jYXRpb24pIHtcbiAgICAgICAgbGV0IG5hbWVcbiAgICAgICAgbGV0IGxpbmVcblxuICAgICAgICBpZiAodGFyZ2V0LnR5cGUgPT09ICdIb29rJykge1xuICAgICAgICAgICAgbmFtZSA9IHBhdGguYmFzZW5hbWUodGFyZ2V0LmxvY2F0aW9uLnVyaSlcbiAgICAgICAgICAgIGxpbmUgPSB0YXJnZXQubG9jYXRpb24ubGluZVxuICAgICAgICB9IGVsc2UgaWYgKHRhcmdldC50eXBlID09PSAnU2NlbmFyaW9PdXRsaW5lJykge1xuICAgICAgICAgICAgbmFtZSA9IHRhcmdldC5uYW1lIHx8IHRhcmdldC50ZXh0XG4gICAgICAgICAgICBsaW5lID0gc291cmNlTG9jYXRpb24ubGluZVxuXG4gICAgICAgICAgICB0YXJnZXQuZXhhbXBsZXNbMF0udGFibGVIZWFkZXIuY2VsbHMuZm9yRWFjaCgoaGVhZGVyLCBpZHgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCc8JyArIGhlYWRlci52YWx1ZSArICc+JykgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXQuZXhhbXBsZXNbMF0udGFibGVCb2R5LmZvckVhY2goKHRhYmxlRW50cnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWJsZUVudHJ5LmxvY2F0aW9uLmxpbmUgPT09IHNvdXJjZUxvY2F0aW9uLmxpbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKCc8JyArIGhlYWRlci52YWx1ZSArICc+JywgdGFibGVFbnRyeS5jZWxsc1tpZHhdLnZhbHVlKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuYW1lID0gdGFyZ2V0Lm5hbWUgfHwgdGFyZ2V0LnRleHRcbiAgICAgICAgICAgIGNvbnN0IGxvY2F0aW9uID0gdGFyZ2V0LmxvY2F0aW9uIHx8IHRhcmdldC5sb2NhdGlvbnNbMF1cbiAgICAgICAgICAgIGxpbmUgPSAobG9jYXRpb24gJiYgbG9jYXRpb24ubGluZSkgfHwgJydcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuYW1lICsgbGluZVxuICAgIH1cblxuICAgIGZvcm1hdE1lc3NhZ2UgKHBhcmFtcykge1xuICAgICAgICBsZXQgbWVzc2FnZSA9IHtcbiAgICAgICAgICAgIHR5cGU6IHBhcmFtcy50eXBlXG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFyYW1zLnBheWxvYWQgJiYgcGFyYW1zLnBheWxvYWQuZXJyb3IpIHtcbiAgICAgICAgICAgIG1lc3NhZ2UuZXJyb3IgPSBwYXJhbXMucGF5bG9hZC5lcnJvclxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIGhvb2sgZmFpbHVyZXMgYXJlIGVtaXR0ZWQgYXMgXCJ0ZXN0OmZhaWxcIlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBpZiAocGFyYW1zLnBheWxvYWQudGl0bGUgJiYgcGFyYW1zLnBheWxvYWQudGl0bGUubWF0Y2goL15cIihiZWZvcmV8YWZ0ZXIpKCBhbGwpKlwiIGhvb2svZykpIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSAnaG9vazplbmQnXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFyYW1zLnBheWxvYWQpIHtcbiAgICAgICAgICAgIG1lc3NhZ2UudGl0bGUgPSBwYXJhbXMucGF5bG9hZC50aXRsZVxuICAgICAgICAgICAgbWVzc2FnZS5wYXJlbnQgPSBwYXJhbXMucGF5bG9hZC5wYXJlbnQgPyBwYXJhbXMucGF5bG9hZC5wYXJlbnQudGl0bGUgOiBudWxsXG5cbiAgICAgICAgICAgIG1lc3NhZ2UuZnVsbFRpdGxlID0gcGFyYW1zLnBheWxvYWQuZnVsbFRpdGxlID8gcGFyYW1zLnBheWxvYWQuZnVsbFRpdGxlKCkgOiBtZXNzYWdlLnBhcmVudCArICcgJyArIG1lc3NhZ2UudGl0bGVcbiAgICAgICAgICAgIG1lc3NhZ2UucGVuZGluZyA9IHBhcmFtcy5wYXlsb2FkLnBlbmRpbmcgfHwgZmFsc2VcbiAgICAgICAgICAgIG1lc3NhZ2UuZmlsZSA9IHBhcmFtcy5wYXlsb2FkLmZpbGVcbiAgICAgICAgICAgIG1lc3NhZ2UuZHVyYXRpb24gPSBwYXJhbXMucGF5bG9hZC5kdXJhdGlvblxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEFkZCB0aGUgY3VycmVudCB0ZXN0IHRpdGxlIHRvIHRoZSBwYXlsb2FkIGZvciBjYXNlcyB3aGVyZSBpdCBoZWxwcyB0b1xuICAgICAgICAgICAgICogaWRlbnRpZnkgdGhlIHRlc3QsIGUuZy4gd2hlbiBydW5uaW5nIGluc2lkZSBhIGJlZm9yZUVhY2ggaG9va1xuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBpZiAocGFyYW1zLnBheWxvYWQuY3R4ICYmIHBhcmFtcy5wYXlsb2FkLmN0eC5jdXJyZW50VGVzdCkge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2UuY3VycmVudFRlc3QgPSBwYXJhbXMucGF5bG9hZC5jdHguY3VycmVudFRlc3QudGl0bGVcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHBhcmFtcy50eXBlLm1hdGNoKC9UZXN0LykpIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlLnBhc3NlZCA9IChwYXJhbXMucGF5bG9hZC5zdGF0ZSA9PT0gJ3Bhc3NlZCcpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwYXJhbXMucGF5bG9hZC5jb250ZXh0KSB7IG1lc3NhZ2UuY29udGV4dCA9IHBhcmFtcy5wYXlsb2FkLmNvbnRleHQgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1lc3NhZ2VcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEN1Y3VtYmVyUmVwb3J0ZXJcbiJdfQ==